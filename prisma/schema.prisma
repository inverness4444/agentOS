generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  passwordHash  String
  role          String    @default("USER")
  status        String    @default("ACTIVE")
  plan          String    @default("FREE")
  balanceCache  Decimal   @default(0)
  advancedMode  Boolean   @default(false)
  twoFactorEnabled   Boolean @default(false)
  twoFactorSecretEnc String?
  accounts      Account[]
  sessions      Session[]
  workflows     Workflow[]
  tasks         Task[]
  taskSteps     TaskStep[]
  taskMessages  TaskMessage[]
  taskFolders   TaskFolder[]
  agents        Agent[]
  tools         Tool[]
  toolFolders   ToolFolder[]
  toolRuns      ToolRun[]
  integrations  Integration[]
  knowledgeItems KnowledgeItem[]
  knowledgeLinks KnowledgeLink[]
  workforceWorkflows WorkforceWorkflow[]
  workforceRuns WorkforceRun[]
  workforceFolders WorkforceFolder[]
  boardThreads    BoardThread[]
  billingCryptoRequests BillingCryptoRequest[] @relation("BillingCryptoRequestUser")
  reviewedBillingCryptoRequests BillingCryptoRequest[] @relation("BillingCryptoRequestReviewer")
  transactions            Transaction[]    @relation("TransactionUser")
  approvedTransactions    Transaction[]    @relation("TransactionApprover")
  balanceLedgers          BalanceLedger[]
  adminActionLogs         AdminActionLog[] @relation("AdminActionActor")
  targetedAdminActionLogs AdminActionLog[] @relation("AdminActionTargetUser")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?
  oauth_token_secret String?
  oauth_token        String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Workflow {
  id        String         @id @default(cuid())
  userId    String
  name      String
  status    String         @default("DRAFT")
  nodes     WorkflowNode[]
  edges     WorkflowEdge[]
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model WorkflowNode {
  id         String   @id @default(cuid())
  workflowId String
  type       String
  positionX  Float
  positionY  Float
  data       String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
}

model WorkflowEdge {
  id         String   @id @default(cuid())
  workflowId String
  source     String
  target     String
  label      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
}

model Task {
  id              String   @id @default(cuid())
  userId          String
  title           String?
  inputText       String
  mode            String
  selectedAgentId String?
  status          String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  startedAt       DateTime?
  finishedAt      DateTime?
  durationMs      Int?
  errorText       String?
  outputSummary   String?
  tags            String?
  folderId        String?

  user     User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  steps    TaskStep[]
  messages TaskMessage[]
  folder   TaskFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([status])
  @@index([updatedAt])
}

model TaskStep {
  id         String   @id @default(cuid())
  taskId     String
  userId     String
  order      Int
  attempt    Int      @default(1)
  kind       String
  agentId    String?
  toolSlug   String?
  status     String
  startedAt  DateTime?
  finishedAt DateTime?
  durationMs Int?
  inputJson  String?
  outputJson String?
  errorText  String?
  toolRunId  String?
  meta       String?

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([userId])
  @@index([status])
}

model TaskMessage {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  role      String
  agentId   String?
  content   String
  createdAt DateTime @default(now())
  meta      String?

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([userId])
}

model Lead {
  id             String   @id @default(cuid())
  taskId         String?
  runId          String?
  agentId        String
  title          String
  url            String
  normalizedUrl  String
  source         String
  geo            String?
  snippet        String?
  whyMatch       String?
  contactHint    String?
  confidence     Int
  searchQueryId  String?
  createdAt      DateTime @default(now())

  searchQuery SearchQuery? @relation(fields: [searchQueryId], references: [id], onDelete: SetNull)

  @@index([taskId])
  @@index([runId])
  @@index([agentId])
  @@index([normalizedUrl])
  @@index([searchQueryId])
  @@index([createdAt])
}

model SearchQuery {
  id         String   @id @default(cuid())
  taskId     String?
  runId      String?
  agentId    String
  query      String
  provider   String
  source     String?
  geo        String?
  limit      Int?
  usageTokens Int?
  status     String   @default("OK")
  errorText  String?
  fetchedAt  DateTime @default(now())

  leads      Lead[]
  rawResults SearchResultRaw[]

  @@index([taskId])
  @@index([runId])
  @@index([agentId])
  @@index([provider])
  @@index([status])
  @@index([fetchedAt])
}

model SearchResultRaw {
  id           String   @id @default(cuid())
  taskId       String?
  runId        String?
  agentId      String
  queryId      String?
  provider     String
  fetchedAt    DateTime @default(now())
  rawJson      String?
  resultsCount Int      @default(0)

  query SearchQuery? @relation(fields: [queryId], references: [id], onDelete: SetNull)

  @@index([taskId])
  @@index([runId])
  @@index([agentId])
  @@index([queryId])
  @@index([provider])
  @@index([fetchedAt])
}

model TaskFolder {
  id        String   @id @default(cuid())
  userId    String
  name      String
  createdAt DateTime @default(now())

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tasks Task[]

  @@index([userId])
}

model Agent {
  id            String     @id @default(cuid())
  userId        String
  name          String
  description   String
  systemPrompt  String
  outputSchema  String
  toolIds       String
  config        String     @default("{}")
  roleKey       String     @default("GENERAL_OPS")
  allowedTaskTypes String[] @default([])
  defaultMode   String     @default("fast")
  webBudget     Int        @default(0)
  maxOutputItems Json?
  escalationPolicy String   @default("best_effort_then_handoff")
  published     Boolean    @default(false)
  runs          AgentRun[]
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model AgentRun {
  id        String   @id @default(cuid())
  agentId   String
  input     String
  output    String
  mode      String   @default("MOCK")
  createdAt DateTime @default(now())

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
}

model Tool {
  id               String   @id @default(cuid())
  userId           String
  folderId         String?
  name             String
  slug             String
  description      String
  category         String
  provider         String
  type             String   @default("internal")
  isActive         Boolean  @default(true)
  inputSchemaJson  String
  outputSchemaJson String
  configJson       String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user   User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  folder ToolFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)
  runs   ToolRun[]

  @@index([userId])
  @@index([folderId])
  @@unique([userId, slug])
}

model ToolFolder {
  id        String   @id @default(cuid())
  userId    String
  name      String
  createdAt DateTime @default(now())

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tools Tool[]

  @@index([userId])
}

model Integration {
  id               String   @id @default(cuid())
  userId           String
  provider         String
  status           String
  secretsEncrypted String?
  metaJson         String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@unique([userId, provider])
}

model ToolRun {
  id         String   @id @default(cuid())
  userId     String
  toolId     String?
  toolSlug   String
  status     String
  inputJson  String
  outputJson String?
  errorText  String?
  startedAt  DateTime @default(now())
  finishedAt DateTime @default(now())
  durationMs Int      @default(0)

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  tool Tool? @relation(fields: [toolId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([toolId])
  @@index([toolSlug])
}

model GeocodeCache {
  key          String   @id
  responseJson String
  createdAt    DateTime @default(now())
}

model KnowledgeItem {
  id                  String          @id @default(cuid())
  workspaceId         String
  title               String
  sourceType          String
  sourceUrl           String?
  contentText         String
  contentHash         String
  tokensCountEstimate Int
  searchText          String
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  workspace User            @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  links     KnowledgeLink[]

  @@index([workspaceId])
}

model KnowledgeLink {
  id          String       @id @default(cuid())
  workspaceId String
  agentId     String?
  knowledgeId String
  scope       String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  workspace User          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  knowledge KnowledgeItem @relation(fields: [knowledgeId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([knowledgeId])
  @@index([agentId])
  @@unique([workspaceId, knowledgeId, agentId, scope])
}

model WorkforceWorkflow {
  id              String   @id @default(cuid())
  userId          String
  name            String
  slug            String
  description     String
  category        String
  status          String
  isActive        Boolean  @default(true)
  isAdvanced      Boolean  @default(false)
  definitionJson  String
  inputSchemaJson String
  outputSchemaJson String
  lastRunAt       DateTime?
  lastRunStatus   String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  runs WorkforceRun[]

  @@index([userId])
  @@unique([userId, slug])
}

model WorkforceRun {
  id          String   @id @default(cuid())
  userId      String
  workflowId  String
  status      String
  inputJson   String
  outputJson  String?
  errorText   String?
  startedAt   DateTime @default(now())
  finishedAt  DateTime @default(now())
  durationMs  Int      @default(0)
  traceJson   String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  workflow WorkforceWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([workflowId])
}

model WorkforceFolder {
  id        String   @id @default(cuid())
  userId    String
  name      String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model BoardThread {
  id         String   @id @default(cuid())
  workspaceId String  @map("workspace_id")
  title      String
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  lastStatus String   @default("Done") @map("last_status")

  workspace   User              @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  messages    BoardMessage[]
  attachments BoardAttachment[]

  @@index([workspaceId])
  @@index([updatedAt])
  @@map("board_threads")
}

model BoardMessage {
  id              String   @id @default(cuid())
  threadId        String   @map("thread_id")
  role            String
  content         String
  attachmentsJson String?  @map("attachments_json")
  createdAt       DateTime @default(now()) @map("created_at")

  thread       BoardThread      @relation(fields: [threadId], references: [id], onDelete: Cascade)
  attachments  BoardAttachment[]

  @@index([threadId])
  @@index([role])
  @@index([createdAt])
  @@map("board_messages")
}

model BoardAttachment {
  id          String   @id @default(cuid())
  threadId    String   @map("thread_id")
  messageId   String   @map("message_id")
  filename    String
  mime        String
  size        Int
  storagePath String   @map("storage_path")
  extractedText String? @map("extracted_text")
  createdAt   DateTime @default(now()) @map("created_at")

  thread  BoardThread  @relation(fields: [threadId], references: [id], onDelete: Cascade)
  message BoardMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([threadId])
  @@index([messageId])
  @@map("board_attachments")
}

model BillingCryptoRequest {
  id               String   @id @default(cuid())
  userId           String   @map("user_id")
  transactionId    String?  @unique @map("transaction_id")
  network          String
  walletAddress    String   @map("wallet_address")
  status           String   @default("PENDING")
  txHash           String?  @map("tx_hash")
  note             String?
  adminNote        String?  @map("admin_note")
  reviewedAt       DateTime? @map("reviewed_at")
  reviewedByUserId String?   @map("reviewed_by_user_id")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  user       User  @relation("BillingCryptoRequestUser", fields: [userId], references: [id], onDelete: Cascade)
  reviewedBy User? @relation("BillingCryptoRequestReviewer", fields: [reviewedByUserId], references: [id], onDelete: SetNull)
  transaction Transaction? @relation(fields: [transactionId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([reviewedByUserId])
  @@map("billing_crypto_requests")
}

model Transaction {
  id                String            @id @default(cuid())
  userId            String            @map("user_id")
  type              String
  amount            Decimal
  currency          String
  status            String            @default("PENDING_APPROVAL")
  metadataJson      String?           @map("metadata_json")
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  approvedByUserId  String?           @map("approved_by_user_id")
  approvedAt        DateTime?         @map("approved_at")
  rejectionReason   String?           @map("rejection_reason")

  user           User             @relation("TransactionUser", fields: [userId], references: [id], onDelete: Cascade)
  approvedBy     User?            @relation("TransactionApprover", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  ledgerEntries  BalanceLedger[]
  adminActions   AdminActionLog[]
  cryptoRequest  BillingCryptoRequest?

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([approvedByUserId])
  @@map("transactions")
}

model BalanceLedger {
  id        String       @id @default(cuid())
  userId    String       @map("user_id")
  delta     Decimal
  reason    String
  source    String   @default("OTHER")
  txId      String?      @map("tx_id")
  createdAt DateTime     @default(now()) @map("created_at")

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  transaction Transaction? @relation(fields: [txId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([txId])
  @@index([createdAt])
  @@map("balance_ledger")
}

model AdminActionLog {
  id           String   @id @default(cuid())
  actorUserId  String   @map("actor_user_id")
  actionType   String   @map("action_type")
  targetUserId String?  @map("target_user_id")
  targetTxId   String?  @map("target_tx_id")
  metadataJson String?  @map("metadata_json")
  ip           String?
  userAgent    String?  @map("user_agent")
  createdAt    DateTime @default(now()) @map("created_at")

  actor      User         @relation("AdminActionActor", fields: [actorUserId], references: [id], onDelete: Cascade)
  targetUser User?        @relation("AdminActionTargetUser", fields: [targetUserId], references: [id], onDelete: SetNull)
  targetTx   Transaction? @relation(fields: [targetTxId], references: [id], onDelete: SetNull)

  @@index([actorUserId])
  @@index([targetUserId])
  @@index([targetTxId])
  @@index([createdAt])
  @@map("admin_action_logs")
}
